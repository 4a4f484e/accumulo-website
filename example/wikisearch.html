<!DOCTYPE html>
<html lang="en">
<head>
<!--
    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/paper/bootstrap.min.css" rel="stylesheet" integrity="sha384-awusxf8AUojygHf2+joICySzB780jVvQaVCAt1clU3QsyAitLGul28Qxb2r1e5g+" crossorigin="anonymous">
<link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs/jq-2.2.3/dt-1.10.12/datatables.min.css">
<link href="/css/accumulo.css" rel="stylesheet" type="text/css">

<title>The wikipedia search example explained, with performance numbers.</title>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdn.datatables.net/v/bs/jq-2.2.3/dt-1.10.12/datatables.min.js"></script>
<script>
  // show location of canonical site if not currently on the canonical site
  $(function() {
    var host = window.location.host;
    if (typeof host !== 'undefined' && host !== 'accumulo.apache.org') {
      $('#non-canonical').show();
    }
  });

  $(function() {
    // decorate section headers with anchors
    return $("h2, h3, h4, h5, h6").each(function(i, el) {
      var $el, icon, id;
      $el = $(el);
      id = $el.attr('id');
      icon = '<i class="fa fa-link"></i>';
      if (id) {
        return $el.append($("<a />").addClass("header-link").attr("href", "#" + id).html(icon));
      }
    });
  });
  
  // configure Google Analytics
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  if (ga.hasOwnProperty('loaded') && ga.loaded === true) {
    ga('create', 'UA-50934829-1', 'apache.org');
    ga('send', 'pageview');
  }
</script>

</head>
<body style="padding-top: 100px">

  <nav class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-items">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="/"><img id="nav-logo" alt="Apache Accumulo" class="img-responsive" src="/images/accumulo-logo.png" width="200"/></a>
    </div>
    <div class="collapse navbar-collapse" id="navbar-items">
      <ul class="nav navbar-nav">
        <li class="nav-link"><a href="/downloads">Download</a></li>
        <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#">Releases<span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li><a href="/release/accumulo-1.8.0/">1.8.0 (Latest)</a></li>
          <li><a href="/release/accumulo-1.7.2/">1.7.2</a></li>
          <li><a href="/release/accumulo-1.6.6/">1.6.6</a></li>
          <li><a href="/release/">Archive</a></li>
        </ul>
        </li>
        <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#">Documentation<span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li><a href="/1.8/accumulo_user_manual.html">User Manual (1.8)</a></li>
          <li><a href="/1.8/apidocs">Javadocs (1.8)</a></li>
          <li><a href="/1.8/examples">Examples (1.8)</a></li>
          <li><a href="/features">Features</a></li>
          <li><a href="/papers">Papers &amp; Presentations</a></li>
          <li><a href="/glossary">Glossary</a></li>
          <li><a href="/docs-archive/">Archive</a></li>
        </ul>
        </li>
        <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#">Community<span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li><a href="/get_involved">Get Involved</a></li>
          <li><a href="/mailing_list">Mailing Lists</a></li>
          <li><a href="/people">People</a></li>
          <li><a href="/projects">Related Projects</a></li>
          <li><a href="/contributor/">Contributor Guide</a></li>
          <li><a href="/governance/">Governance</a></li>
        </ul>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#">Apache Software Foundation<span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li><a href="https://www.apache.org">Apache Homepage <i class="fa fa-external-link"></i></a></li>
          <li><a href="https://www.apache.org/licenses/LICENSE-2.0">License <i class="fa fa-external-link"></i></a></li>
          <li><a href="https://www.apache.org/foundation/sponsorship">Sponsorship <i class="fa fa-external-link"></i></a></li>
          <li><a href="https://www.apache.org/security">Security <i class="fa fa-external-link"></i></a></li>
          <li><a href="https://www.apache.org/foundation/thanks">Thanks <i class="fa fa-external-link"></i></a></li>
          <li><a href="https://www.apache.org/foundation/policies/conduct">Code of Conduct <i class="fa fa-external-link"></i></a></li>
        </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>


  <div class="container">
    <div class="row">
      <div class="col-md-12">

        <div id="non-canonical" style="display: none; background-color: #F0E68C; padding-left: 1em;">
          Visit the official site at: <a href="https://accumulo.apache.org">https://accumulo.apache.org</a>
        </div>
        <div id="content">
          
          <h1 class="title">The wikipedia search example explained, with performance numbers.</h1>
          
          <h2 id="apache-accumulo-query-performance">Apache Accumulo Query Performance</h2>

<h2 id="sample-application">Sample Application</h2>

<p>Starting with release 1.4, Accumulo includes an example web application that
provides a flexible, scalable search over the articles of Wikipedia, a widely
available medium-sized corpus.</p>

<p>The example uses an indexing technique helpful for doing multiple logical tests
against content. In this case, we can perform a word search on Wikipedia
articles. The sample application takes advantage of 3 unique capabilities of
Accumulo:</p>

<ol>
  <li>Extensible iterators that operate within the distributed tablet servers of
the key-value store</li>
  <li>Custom aggregators which can efficiently condense information during the
various life-cycles of the log-structured merge tree</li>
  <li>Custom load balancing, which ensures that a table is evenly distributed on
all tablet servers</li>
</ol>

<p>In the example, Accumulo tracks the cardinality of all terms as elements are
ingested. If the cardinality is small enough, it will track the set of
documents by term directly. For example:</p>

<style type="text/css">
table.wiki, table.wiki td, table.wiki th {
  padding-right: 5px;
  padding-left: 5px;
  border: 1px solid black;
  border-collapse: collapse;
}
table.wiki td {
  text-align: right;
}
</style>

<table class="wiki">
  <thead>
    <tr>
      <th>Row (word)</th>
      <th style="text-align: right">Value (count)</th>
      <th style="text-align: left">Value (document list)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Octopus</td>
      <td style="text-align: right">2</td>
      <td style="text-align: left">[Document 57, Document 220]</td>
    </tr>
    <tr>
      <td>Other</td>
      <td style="text-align: right">172,849</td>
      <td style="text-align: left">[]</td>
    </tr>
    <tr>
      <td>Ostrich</td>
      <td style="text-align: right">1</td>
      <td style="text-align: left">[Document 901]</td>
    </tr>
  </tbody>
</table>

<p>Searches can be optimized to focus on low-cardinality terms. To create these
counts, the example installs “aggregators” which are used to combine inserted
values. The ingester just writes simple “(Octopus, 1, Document 57)” tuples.
The tablet servers then used the installed aggregators to merge the cells as
the data is re-written, or queried. This reduces the in-memory locking
required to update high-cardinality terms, and defers aggregation to a later
time, where it can be done more efficiently.</p>

<p>The example also creates a reverse word index to map each word to the document
in which it appears. But it does this by choosing an arbitrary partition for
the document. The article, and the word index for the article are grouped
together into the same partition. For example:</p>

<table class="wiki">
  <thead>
    <tr>
      <th>Row (partition)</th>
      <th>Column Family</th>
      <th>Column Qualifier</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>D</td>
      <td>Document 57</td>
      <td>“smart Octopus”</td>
    </tr>
    <tr>
      <td>1</td>
      <td>Word, Octopus</td>
      <td>Document 57</td>
      <td> </td>
    </tr>
    <tr>
      <td>1</td>
      <td>Word, smart</td>
      <td>Document 57</td>
      <td> </td>
    </tr>
    <tr>
      <td>…</td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>2</td>
      <td>D</td>
      <td>Document 220</td>
      <td>“big Octopus”</td>
    </tr>
    <tr>
      <td>2</td>
      <td>Word, big</td>
      <td>Document 220</td>
      <td> </td>
    </tr>
    <tr>
      <td>2</td>
      <td>Word, Octopus</td>
      <td>Document 220</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p>Of course, there would be large numbers of documents in each partition, and the
elements of those documents would be interlaced according to their sort order.</p>

<p>By dividing the index space into partitions, the multi-word searches can be
performed in parallel across all the nodes. Also, by grouping the document
together with its index, a document can be retrieved without a second request
from the client. The query “octopus” and “big” will be performed on all the
servers, but only those partitions for which the low-cardinality term “octopus”
can be found by using the aggregated reverse index information. The query for a
document is performed by extensions provided in the example. These extensions
become part of the tablet server’s iterator stack. By cloning the underlying
iterators, the query extensions can seek to specific words within the index,
and when it finds a matching document, it can then seek to the document
location and retrieve the contents.</p>

<p>We loaded the example on a cluster of 10 servers, each with 12 cores, and 32G
RAM, 6 500G drives. Accumulo tablet servers were allowed a maximum of 3G of
working memory, of which 2G was dedicated to caching file data.</p>

<p>Following the instructions in the example, the Wikipedia XML data for articles
was loaded for English, Spanish and German languages into 10 partitions. The
data is not partitioned by language: multiple languages were used to get a
larger set of test data. The data load took around 8 hours, and has not been
optimized for scale. Once the data was loaded, the content was compacted which
took about 35 minutes.</p>

<p>The example uses the language-specific tokenizers available from the Apache
Lucene project for Wikipedia data.</p>

<p>Original files:</p>

<table class="wiki">
  <thead>
    <tr>
      <th>Articles</th>
      <th>Compressed size</th>
      <th>Filename</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1.3M</td>
      <td>2.5G</td>
      <td>dewiki-20111120-pages-articles.xml.bz2</td>
    </tr>
    <tr>
      <td>3.8M</td>
      <td>7.9G</td>
      <td>enwiki-20111115-pages-articles.xml.bz2</td>
    </tr>
    <tr>
      <td>0.8M</td>
      <td>1.4G</td>
      <td>eswiki-20111112-pages-articles.xml.bz2</td>
    </tr>
  </tbody>
</table>

<p>The resulting tables:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&gt; du -p wiki.*
      47,325,680,634 [wiki]
       5,125,169,305 [wikiIndex]
                 413 [wikiMetadata]
       5,521,690,682 [wikiReverseIndex]
</code></pre>
</div>

<p>Roughly a 6:1 increase in size.</p>

<p>We performed the following queries, and repeated the set 5 times. The query
language is much more expressive than what is shown below. The actual query
specified that these words were to be found in the body of the article. Regular
expressions, searches within titles, negative tests, etc are available.</p>

<table class="wiki">
  <thead>
    <tr>
      <th>Query</th>
      <th>Sample 1 (seconds)</th>
      <th>Sample 2 (seconds)</th>
      <th>Sample 3 (seconds)</th>
      <th>Sample 4 (seconds)</th>
      <th>Sample 5 (seconds)</th>
      <th>Matches</th>
      <th>Result Size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>“old” and “man” and “sea”</td>
      <td>4.07</td>
      <td>3.79</td>
      <td>3.65</td>
      <td>3.85</td>
      <td>3.67</td>
      <td>22,956</td>
      <td>3,830,102</td>
    </tr>
    <tr>
      <td>“paris” and “in” and “the” and “spring”</td>
      <td>3.06</td>
      <td>3.06</td>
      <td>2.78</td>
      <td>3.02</td>
      <td>2.92</td>
      <td>10,755</td>
      <td>1,757,293</td>
    </tr>
    <tr>
      <td>“rubber” and “ducky” and “ernie”</td>
      <td>0.08</td>
      <td>0.08</td>
      <td>0.1</td>
      <td>0.11</td>
      <td>0.1</td>
      <td>6</td>
      <td>808</td>
    </tr>
    <tr>
      <td>“fast” and ( “furious” or “furriest”)</td>
      <td>1.34</td>
      <td>1.33</td>
      <td>1.3</td>
      <td>1.31</td>
      <td>1.31</td>
      <td>2,973</td>
      <td>493,800</td>
    </tr>
    <tr>
      <td>“slashdot” and “grok”</td>
      <td>0.06</td>
      <td>0.06</td>
      <td>0.06</td>
      <td>0.06</td>
      <td>0.06</td>
      <td>14</td>
      <td>2,371</td>
    </tr>
    <tr>
      <td>“three” and “little” and “pigs”</td>
      <td>0.92</td>
      <td>0.91</td>
      <td>0.9</td>
      <td>1.08</td>
      <td>0.88</td>
      <td>2,742</td>
      <td>481,531</td>
    </tr>
  </tbody>
</table>

<p>Because the terms are tested together within the tablet server, even fairly
high-cardinality terms such as “old,” “man,” and “sea” can be tested
efficiently, without needing to return to the client, or make distributed calls
between servers to perform the intersection between terms.</p>

<p>For reference, here are the cardinalities for all the terms in the query
(remember, this is across all languages loaded):</p>

<table class="wiki">
  <thead>
    <tr>
      <th>Term</th>
      <th>Cardinality</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ducky</td>
      <td>795</td>
    </tr>
    <tr>
      <td>ernie</td>
      <td>13,433</td>
    </tr>
    <tr>
      <td>fast</td>
      <td>166,813</td>
    </tr>
    <tr>
      <td>furious</td>
      <td>10,535</td>
    </tr>
    <tr>
      <td>furriest</td>
      <td>45</td>
    </tr>
    <tr>
      <td>grok</td>
      <td>1,168</td>
    </tr>
    <tr>
      <td>in</td>
      <td>1,884,638</td>
    </tr>
    <tr>
      <td>little</td>
      <td>320,748</td>
    </tr>
    <tr>
      <td>man</td>
      <td>548,238</td>
    </tr>
    <tr>
      <td>old</td>
      <td>720,795</td>
    </tr>
    <tr>
      <td>paris</td>
      <td>232,464</td>
    </tr>
    <tr>
      <td>pigs</td>
      <td>8,356</td>
    </tr>
    <tr>
      <td>rubber</td>
      <td>17,235</td>
    </tr>
    <tr>
      <td>sea</td>
      <td>247,231</td>
    </tr>
    <tr>
      <td>slashdot</td>
      <td>2,343</td>
    </tr>
    <tr>
      <td>spring</td>
      <td>125,605</td>
    </tr>
    <tr>
      <td>the</td>
      <td>3,509,498</td>
    </tr>
    <tr>
      <td>three</td>
      <td>718,810</td>
    </tr>
  </tbody>
</table>

<p>Accumulo supports caching index information, which is turned on by default, and
for the non-index blocks of a file, which is not. After turning on data block
  caching for the wiki table:</p>

<table class="wiki">
  <thead>
    <tr>
      <th>Query</th>
      <th>Sample 1 (seconds)</th>
      <th>Sample 2 (seconds)</th>
      <th>Sample 3 (seconds)</th>
      <th>Sample 4 (seconds)</th>
      <th>Sample 5 (seconds)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>“old” and “man” and “sea”</td>
      <td>2.47</td>
      <td>2.48</td>
      <td>2.51</td>
      <td>2.48</td>
      <td>2.49</td>
    </tr>
    <tr>
      <td>“paris” and “in” and “the” and “spring”</td>
      <td>1.33</td>
      <td>1.42</td>
      <td>1.6</td>
      <td>1.61</td>
      <td>1.47</td>
    </tr>
    <tr>
      <td>“rubber” and “ducky” and “ernie”</td>
      <td>0.07</td>
      <td>0.08</td>
      <td>0.07</td>
      <td>0.07</td>
      <td>0.07</td>
    </tr>
    <tr>
      <td>“fast” and ( “furious” or “furriest”)</td>
      <td>1.28</td>
      <td>0.78</td>
      <td>0.77</td>
      <td>0.79</td>
      <td>0.78</td>
    </tr>
    <tr>
      <td>“slashdot” and “grok”</td>
      <td>0.04</td>
      <td>0.04</td>
      <td>0.04</td>
      <td>0.04</td>
      <td>0.04</td>
    </tr>
    <tr>
      <td>“three” and “little” and “pigs”</td>
      <td>0.55</td>
      <td>0.32</td>
      <td>0.32</td>
      <td>0.31</td>
      <td>0.27</td>
    </tr>
  </tbody>
</table>

<p>For comparison, these are the cold start lookup times (restart Accumulo, and
drop the operating system disk cache):</p>

<table class="wiki">
  <thead>
    <tr>
      <th>Query</th>
      <th>Sample</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>“old” and “man” and “sea”</td>
      <td>13.92</td>
    </tr>
    <tr>
      <td>“paris” and “in” and “the” and “spring”</td>
      <td>8.46</td>
    </tr>
    <tr>
      <td>“rubber” and “ducky” and “ernie”</td>
      <td>2.96</td>
    </tr>
    <tr>
      <td>“fast” and ( “furious” or “furriest”)</td>
      <td>6.77</td>
    </tr>
    <tr>
      <td>“slashdot” and “grok”</td>
      <td>4.06</td>
    </tr>
    <tr>
      <td>“three” and “little” and “pigs”</td>
      <td>8.13</td>
    </tr>
  </tbody>
</table>

<h3 id="random-query-load">Random Query Load</h3>

<p>Random queries were generated using common english words. A uniform random
sample of 3 to 5 words taken from the 10000 most common words in the Project
Gutenberg’s online text collection were joined with “and”. Words containing
anything other than letters (such as contractions) were not used. A client was
started simultaneously on each of the 10 servers and each ran 100 random
queries (1000 queries total).</p>

<table class="wiki">
  <thead>
    <tr>
      <th>Time</th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>41.97</td>
      <td>440,743</td>
    </tr>
    <tr>
      <td>41.61</td>
      <td>320,522</td>
    </tr>
    <tr>
      <td>42.11</td>
      <td>347,969</td>
    </tr>
    <tr>
      <td>38.32</td>
      <td>275,655</td>
    </tr>
  </tbody>
</table>

<h3 id="query-load-during-ingest">Query Load During Ingest</h3>

<p>The English wikipedia data was re-ingested on top of the existing, compacted
data. The following query samples were taken in 5 minute intervals while
ingesting 132 articles/second:</p>

<table class="wiki">
  <thead>
    <tr>
      <th>Query</th>
      <th>Sample 1 (seconds)</th>
      <th>Sample 2 (seconds)</th>
      <th>Sample 3 (seconds)</th>
      <th>Sample 4 (seconds)</th>
      <th>Sample 5 (seconds)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>“old” and “man” and “sea”</td>
      <td>4.91</td>
      <td>3.92</td>
      <td>11.58</td>
      <td>9.86</td>
      <td>10.21</td>
    </tr>
    <tr>
      <td>“paris” and “in” and “the” and “spring”</td>
      <td>5.03</td>
      <td>3.37</td>
      <td>12.22</td>
      <td>3.29</td>
      <td>9.46</td>
    </tr>
    <tr>
      <td>“rubber” and “ducky” and “ernie”</td>
      <td>4.21</td>
      <td>2.04</td>
      <td>8.57</td>
      <td>1.54</td>
      <td>1.68</td>
    </tr>
    <tr>
      <td>“fast” and ( “furious” or “furriest”)</td>
      <td>5.84</td>
      <td>2.83</td>
      <td>2.56</td>
      <td>3.12</td>
      <td>3.09</td>
    </tr>
    <tr>
      <td>“slashdot” and “grok”</td>
      <td>5.68</td>
      <td>2.62</td>
      <td>2.2</td>
      <td>2.78</td>
      <td>2.8</td>
    </tr>
    <tr>
      <td>“three” and “little” and “pigs”</td>
      <td>7.82</td>
      <td>3.42</td>
      <td>2.79</td>
      <td>3.29</td>
      <td>3.3</td>
    </tr>
  </tbody>
</table>

        </div>

        
<footer>

  <p><a href="https://www.apache.org"><img src="/images/feather-small.gif" alt="Apache Software Foundation" id="asf-logo" height="100" /></a></p>

  <p>Copyright © 2011-2016 The Apache Software Foundation. Licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>.</p>

</footer>


      </div>
    </div>
  </div>
</body>
</html>
