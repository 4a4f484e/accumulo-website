<!DOCTYPE html>
<html lang="en">
<head>
<!--
    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE- 2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/bootstrap-theme.min.css" rel="stylesheet">
<link href="/css/dataTables.bootstrap.css" rel="stylesheet">
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/jquery.dataTables.min.js"></script>
<script src="/js/dataTables.bootstrap.js"></script>
<link href="/css/accumulo.css" rel="stylesheet" type="text/css">
<link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
<title>The wikipedia search example explained, with performance numbers.</title>

<script>
$(function() {
  var host = window.location.host;
  if (typeof host !== 'undefined' && host !== 'accumulo.apache.org') {
    $('#non-canonical').show();
  }
});
</script>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
 (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
 m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

if (ga.hasOwnProperty('loaded') && ga.loaded === true) {
  ga('create', 'UA-50934829-1', 'apache.org');
  ga('send', 'pageview');
}
</script>
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-items">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/index.html">Accumulo</a>
    </div>
    <div class="collapse navbar-collapse" id="navbar-items">
      <ul class="nav navbar-nav">
        <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#">Project<span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li id="nav_index"><a href="/">Home</a></li>
          <li id="nav_downloads"><a href="/downloads/">Downloads</a></li>
          <li id="nav_features"><a href="/notable_features.html">Features</a></li>
          <li><a href="http://www.apache.org/licenses/LICENSE-2.0"><i class="fa fa-external-link"></i> License</a></li>
        </ul>
        </li>
        <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#">Community<span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li id="nav_getinvolved"><a href="/get_involved.html">Get Involved</a></li>
          <li id="nav_mailinglists"><a href="/mailing_list.html">Mailing Lists</a></li>
          <li id="nav_people"><a href="/people.html">People</a></li>
          <li id="nav_blog"><a href="https://blogs.apache.org/accumulo/">Blog</a></li>
          <li class="divider"></li>
          <li class="dropdown-header">Governance</li>
          <li id="nav_bylaws"><a href="/bylaws.html">Bylaws</a></li>
          <li id="nav_consensusbuilding"><a href="/governance/consensusBuilding.html">Consensus Building</a></li>
          <li id="nav_lazyconsensus"><a href="/governance/lazyConsensus.html">Lazy Consensus</a></li>
          <li id="nav_govreleasing"><a href="/governance/releasing.html">Releasing</a></li>
          <li id="nav_voting"><a href="/governance/voting.html">Voting</a></li>
        </ul>
        </li>
        <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#">Development<span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li id="nav_source"><a href="/source.html">Source &amp; Guide</a></li>
          <li id="nav_git"><a href="/git.html">Git Workflow</a></li>
          <li id="nav_versioning"><a href="/versioning.html">Versioning</a></li>
          <li id="nav_contrib"><a href="/contrib.html">Contrib Projects</a></li>
          <li id="nav_rb"><a href="/rb.html">Review Board</a></li>
          <li id="nav_releasing"><a href="/releasing.html">Making Releases</a></li>
          <li id="nav_verify_release"><a href="/verifying_releases.html">Verifying Releases</a></li>
          <li><a href="https://issues.apache.org/jira/browse/accumulo"><i class="fa fa-external-link"></i> Issues</a></li>
          <li><a href="https://builds.apache.org/view/A-D/view/Accumulo/"><i class="fa fa-external-link"></i> Builds</a></li>
        </ul>
        </li>
        <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#">Documentation<span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li class="dropdown-header">Manual</li>
          <li><a href="/1.6/accumulo_user_manual.html">1.6</a></li>
          <li><a href="/1.7/accumulo_user_manual.html">1.7</a></li>
          <li class="divider"></li>
          <li class="dropdown-header">Javadoc</li>
          <li><a href="/1.6/apidocs">1.6</a></li>
          <li><a href="/1.7/apidocs">1.7</a></li>
          <li class="divider"></li>
          <li class="dropdown-header">Examples</li>
          <li id="nav_examples_1_6"><a href="/1.6/examples">1.6</a></li>
          <li id="nav_examples_1_7"><a href="/1.7/examples">1.7</a></li>
          <li class="divider"></li>
          <li id="old_documentation"><a href="/old_documentation.html">Docs for Older Verisons</a></li>
          <li id="nav_screenshots"><a href="/screenshots.html">Screenshots</a></li>
          <li id="nav_papers"><a href="/papers.html">Papers &amp; Other Links</a></li>
          <li id="nav_glossary"><a href="/glossary.html">Glossary</a></li>
        </ul>
        </li>
        <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#">Release Notes<span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li><a href="/release_notes/1.7.1.html">1.7.1</a></li>
          <li><a href="/release_notes/1.6.5.html">1.6.5</a></li>
          <li class="divider"></li>
          <li><a href="/release_notes/">Archives</a></li>
        </ul>
        </li>
        <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#">Other<span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="/papers.html">Papers &amp; Presentations</a></li>
            <li><a href="/projects.html">Community Projects</a></li>
          </ul>
          </li>
          <li class="dropdown">
          <a class="dropdown-toggle" data-toggle="dropdown" href="#">ASF Links<span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="http://www.apache.org"><i class="fa fa-external-link"></i> Apache Software Foundation</a></li>
            <li><a href="http://www.apache.org/foundation/sponsorship.html"><i class="fa fa-external-link"></i> Sponsorship</a></li>
            <li><a href="http://www.apache.org/security/"><i class="fa fa-external-link"></i> Security</a></li>
            <li><a href="http://www.apache.org/foundation/thanks.html"><i class="fa fa-external-link"></i> Thanks</a></li>
            <li><a href="http://www.apache.org/foundation/policies/conduct.html"><i class="fa fa-external-link"></i> Code of Conduct</a></li>
          </ul>
          </li>
        </ul>
        <form method="GET" action="http://search-hadoop.com/" class="navbar-form navbar-right" role="search">
          <div class="form-group">
            <input type="text" name="q" class="form-control" placeholder="Search"/>
            <input type="hidden" name="fc_project" value="Accumulo"/>
          </div>
          <button type="submit" class="btn btn-default"><span class="glyphicon glyphicon-search"></span></button>
        </form>
      </div>
    </div>
  </nav>


<div class="container-fluid">
  <div class="row">
    <div class="col-md-2" id="sidebar">
      <div style="text-align: center">
        <a href="/"><img id="logo" alt="Apache Accumulo &trade;" class="img-responsive" src="/images/accumulo-logo.png"/></a>
        <br />
        Latest 1.7 release: <strong>1.7.1</strong><br />
        Latest 1.6 release: <strong>1.6.5</strong><br />
        <br>
        <a id="download-button-sidebar" class="btn btn-success btn-block" href="/downloads/" role="button">Download</a>
      </div>
      <hr>
      <table class="table" id="sociallinks">
        <tr><td><img src="/images/Twitter_logo_blue.png" style="height: 1em"></td><td><a href="https://twitter.com/apacheaccumulo">@ApacheAccumulo</a></td></tr>
        <tr><td><img src="/images/InBug-16px_0.png"></td><td><a href="https://www.linkedin.com/groups/Apache-Accumulo-Professionals-4554913">Apache Accumulo Professionals</a></td></tr>
        <tr><td><img src="/images/GitHub-Mark-32px.png" style="height: 1em"></td><td><a href="https://github.com/apache/accumulo">apache / accumulo</a></td></tr>
        <tr><td><span class="glyphicon glyphicon-comment"></span></td><td><a href="irc://chat.freenode.net/accumulo">#accumulo @ freenode</a></td></tr>
        <tr><td><img src="/favicon.png" width="16" /></td><td><a href="http://blogs.apache.org/accumulo">Apache Accumulo Blog</a></td></tr>
      </table>
      <hr>
      <a id="accumulo-summit-logo" href="http://accumulosummit.com/"><img alt="Accumulo Summit" class="img-responsive" src="/images/accumulo-summit.png"></a>
    </div>
    <div class="col-md-8 col-md-offset-1">

      <div id="non-canonical" style="display: none; background-color: #F0E68C; padding-left: 1em;">
        Visit the official site at: <a href="https://accumulo.apache.org">https://accumulo.apache.org</a>
      </div>
      <div id="content">
        
        <h1 class="title">The wikipedia search example explained, with performance numbers.</h1>
        
        <h2 id="apache-accumulo-query-performance">Apache Accumulo Query Performance</h2>

<h2 id="sample-application">Sample Application</h2>

<p>Starting with release 1.4, Accumulo includes an example web application that provides a flexible,  scalable search over the articles of Wikipedia, a widely available medium-sized corpus.</p>

<p>The example uses an indexing technique helpful for doing multiple logical tests against content.  In this case, we can perform a word search on Wikipedia articles.   The sample application takes advantage of 3 unique capabilities of Accumulo:</p>

<ol>
  <li>Extensible iterators that operate within the distributed tablet servers of the key-value store</li>
  <li>Custom aggregators which can efficiently condense information during the various life-cycles of the log-structured merge tree</li>
  <li>Custom load balancing, which ensures that a table is evenly distributed on all tablet servers</li>
</ol>

<p>In the example, Accumulo tracks the cardinality of all terms as elements are ingested.  If the cardinality is small enough, it will track the set of documents by term directly.  For example:</p>

<style type="text/css">
table, td, th {
  padding-right: 5px;
  padding-left: 5px;
  border: 1px solid black;
  border-collapse: collapse;
}
td {
  text-align: right;
}
.lt {
  text-align: left;
}
</style>

<table>
<tr>
<th>Row (word)</th>
<th colspan="2">Value (count, document list)</th>
</tr><tr>
<td>Octopus
<td>2
<td class="lt">[Document 57, Document 220]
<tr>
<td>Other
<td>172,849
<td class="lt">[]
<tr>
<td>Ostrich
<td>1
<td class="lt">[Document 901]



Searches can be optimized to focus on low-cardinality terms.  To create these counts, the example installs “aggregators” which are used to combine inserted values.  The ingester just writes simple  “(Octopus, 1, Document 57)” tuples.  The tablet servers then used the installed aggregators to merge the cells as the data is re-written, or queried.  This reduces the in-memory locking required to update high-cardinality terms, and defers aggregation to a later time, where it can be done more efficiently.

The example also creates a reverse word index to map each word to the document in which it appears. But it does this by choosing an arbitrary partition for the document.  The article, and the word index for the article are grouped together into the same partition.  For example:

<table>
<tr>
<th>Row (partition)
<th>Column Family
<th>Column Qualifier
<th>Value
<tr>
<td>1
<td>D
<td>Document 57
<td>“smart Octopus”
<tr>
<td>1
<td>Word, Octopus
<td>Document 57
<td>
<tr>
<td>1
<td>Word, smart
<td>Document 57
<td>
<tr>
<td>...
<td>
<td>
<td>
<tr>
<td>2
<td>D
<td>Document 220
<td>“big Octopus”
<tr>
<td>2
<td>Word, big
<td>Document 220
<td>
<tr>
<td>2
<td>Word, Octopus
<td>Document 220
<td>


Of course, there would be large numbers of documents in each partition, and the elements of those documents would be interlaced according to their sort order.

By dividing the index space into partitions, the multi-word searches can be performed in parallel across all the nodes.  Also, by grouping the document together with its index, a document can be retrieved without a second request from the client.  The query “octopus” and “big” will be performed on all the servers, but only those partitions for which the low-cardinality term “octopus” can be found by using the aggregated reverse index information.  The query for a document is performed by extensions provided in the example.  These extensions become part of the tablet server's iterator stack.  By cloning the underlying iterators, the query extensions can seek to specific words within the index, and when it finds a matching document, it can then seek to the document location and retrieve the contents.

We loaded the example on a  cluster of 10 servers, each with 12 cores, and 32G RAM, 6 500G drives.  Accumulo tablet servers were allowed a maximum of 3G of working memory, of which 2G was dedicated to caching file data.

Following the instructions in the example, the Wikipedia XML data for articles was loaded for English, Spanish and German languages into 10 partitions.  The data is not partitioned by language: multiple languages were used to get a larger set of test data.  The data load took around 8 hours, and has not been optimized for scale.  Once the data was loaded, the content was compacted which took about 35 minutes.

The example uses the language-specific tokenizers available from the Apache Lucene project for Wikipedia data.

Original files:

<table>
<tr>
<th>Articles
<th>Compressed size
<th>Filename
<tr>
<td>1.3M
<td>2.5G
<td>dewiki-20111120-pages-articles.xml.bz2
<tr>
<td>3.8M
<td>7.9G
<td>enwiki-20111115-pages-articles.xml.bz2
<tr>
<td>0.8M
<td>1.4G
<td>eswiki-20111112-pages-articles.xml.bz2


The resulting tables:

    &gt; du -p wiki.*
          47,325,680,634 [wiki]
           5,125,169,305 [wikiIndex]
                     413 [wikiMetadata]
           5,521,690,682 [wikiReverseIndex]

Roughly a 6:1 increase in size.

We performed the following queries, and repeated the set 5 times.  The query language is much more expressive than what is shown below.  The actual query specified that these words were to be found in the body of the article.  Regular expressions, searches within titles, negative tests, etc are available.

<table>
<tr>
<th>Query
<th colspan="5">Samples (seconds)
<th>Matches
<th>Result Size
<tr>
<td>“old” and “man” and “sea”
<td>4.07
<td>3.79
<td>3.65
<td>3.85
<td>3.67
<td>22,956
<td>3,830,102
<tr>
<td>“paris” and “in” and “the” and “spring”
<td>3.06
<td>3.06
<td>2.78
<td>3.02
<td>2.92
<td>10,755
<td>1,757,293
<tr>
<td>“rubber” and “ducky” and “ernie”
<td>0.08
<td>0.08
<td>0.1
<td>0.11
<td>0.1
<td>6
<td>808
<tr>
<td>“fast”  and ( “furious” or “furriest”) 
<td>1.34
<td>1.33
<td>1.3
<td>1.31
<td>1.31
<td>2,973
<td>493,800
<tr>
<td>“slashdot” and “grok”
<td>0.06
<td>0.06
<td>0.06
<td>0.06
<td>0.06
<td>14
<td>2,371
<tr>
<td>“three” and “little” and “pigs”
<td>0.92
<td>0.91
<td>0.9
<td>1.08
<td>0.88
<td>2,742
<td>481,531


Because the terms are tested together within the tablet server, even fairly high-cardinality terms such as “old,” “man,” and “sea” can be tested efficiently, without needing to return to the client, or make distributed calls between servers to perform the intersection between terms.

For reference, here are the cardinalities for all the terms in the query (remember, this is across all languages loaded):

<table>
<tr> <th>Term <th> Cardinality
<tr> <td> ducky <td> 795
<tr> <td> ernie <td> 13,433
<tr> <td> fast <td> 166,813
<tr> <td> furious <td> 10,535
<tr> <td> furriest <td> 45
<tr> <td> grok <td> 1,168
<tr> <td> in <td> 1,884,638
<tr> <td> little <td> 320,748
<tr> <td> man <td> 548,238
<tr> <td> old <td> 720,795
<tr> <td> paris <td> 232,464
<tr> <td> pigs <td> 8,356
<tr> <td> rubber <td> 17,235
<tr> <td> sea <td> 247,231
<tr> <td> slashdot <td> 2,343
<tr> <td> spring <td> 125,605
<tr> <td> the <td> 3,509,498
<tr> <td> three <td> 718,810



Accumulo supports caching index information, which is turned on by default, and for the non-index blocks of a file, which is not. After turning on data block caching for the wiki table:

<table>
<tr>
<th>Query
<th colspan="5">Samples (seconds)
<tr>
<td>“old” and “man” and “sea”
<td>2.47
<td>2.48
<td>2.51
<td>2.48
<td>2.49
<tr>
<td>“paris” and “in” and “the” and “spring”
<td>1.33
<td>1.42
<td>1.6
<td>1.61
<td>1.47
<tr>
<td>“rubber” and “ducky” and “ernie”
<td>0.07
<td>0.08
<td>0.07
<td>0.07
<td>0.07
<tr>
<td>“fast” and ( “furious” or “furriest”) 
<td>1.28
<td>0.78
<td>0.77
<td>0.79
<td>0.78
<tr>
<td>“slashdot” and “grok”
<td>0.04
<td>0.04
<td>0.04
<td>0.04
<td>0.04
<tr>
<td>“three” and “little” and “pigs”
<td>0.55
<td>0.32
<td>0.32
<td>0.31
<td>0.27

<table>
<p>
For comparison, these are the cold start lookup times (restart Accumulo, and drop the operating system disk cache):

<table>
<tr>
<th>Query
<th>Sample
<tr>
<td>“old” and “man” and “sea”
<td>13.92
<tr>
<td>“paris” and “in” and “the” and “spring”
<td>8.46
<tr>
<td>“rubber” and “ducky” and “ernie”
<td>2.96
<tr>
<td>“fast” and ( “furious” or “furriest”) 
<td>6.77
<tr>
<td>“slashdot” and “grok”
<td>4.06
<tr>
<td>“three” and “little” and “pigs”
<td>8.13


### Random Query Load

Random queries were generated using common english words.  A uniform random sample of 3 to 5 words taken from the 10000 most common words in the Project Gutenberg's online text collection were joined with “and”.  Words containing anything other than letters (such as contractions) were not used.  A client was started simultaneously on each of the 10 servers and each ran 100 random queries (1000 queries total).


<table>
<tr>
<th>Time
<th>Count
<tr>
<td>41.97
<td>440,743
<tr>
<td>41.61
<td>320,522
<tr>
<td>42.11
<td>347,969
<tr>
<td>38.32
<td>275,655


### Query Load During Ingest

The English wikipedia data was re-ingested on top of the existing, compacted data. The following  query samples were taken in 5 minute intervals while ingesting 132 articles/second:


<table>
<tr>
<th>Query
<th colspan="5">Samples (seconds)
<tr>
<td>“old” and “man” and “sea”
<td>4.91
<td>3.92
<td>11.58
<td>9.86
<td>10.21
<tr>
<td>“paris” and “in” and “the” and “spring”
<td>5.03
<td>3.37
<td>12.22
<td>3.29
<td>9.46
<tr>
<td>“rubber” and “ducky” and “ernie”
<td>4.21
<td>2.04
<td>8.57
<td>1.54
<td>1.68
<tr>
<td>“fast”  and ( “furious” or “furriest”) 
<td>5.84
<td>2.83
<td>2.56
<td>3.12
<td>3.09
<tr>
<td>“slashdot” and “grok”
<td>5.68
<td>2.62
<td>2.2
<td>2.78
<td>2.8
<tr>
<td>“three” and “little” and “pigs”
<td>7.82
<td>3.42
<td>2.79
<td>3.29
<td>3.3

</td></td></td></td></td></td></tr></td></td></td></td></td></td></tr></td></td></td></td></td></td></tr></td></td></td></td></td></td></tr></td></td></td></td></td></td></tr></td></td></td></td></td></td></tr></th></th></tr></table></td></td></tr></td></td></tr></td></td></tr></td></td></tr></th></th></tr></table></td></td></tr></td></td></tr></td></td></tr></td></td></tr></td></td></tr></td></td></tr></th></th></tr></table></p></table></td></td></td></td></td></td></tr></td></td></td></td></td></td></tr></td></td></td></td></td></td></tr></td></td></td></td></td></td></tr></td></td></td></td></td></td></tr></td></td></td></td></td></td></tr></th></th></tr></table></td></td></tr></td></td></tr></td></td></tr></td></td></tr></td></td></tr></td></td></tr></td></td></tr></td></td></tr></td></td></tr></td></td></tr></td></td></tr></td></td></tr></td></td></tr></td></td></tr></td></td></tr></td></td></tr></td></td></tr></td></td></tr></th></th></tr></table></td></td></td></td></td></td></td></td></tr></td></td></td></td></td></td></td></td></tr></td></td></td></td></td></td></td></td></tr></td></td></td></td></td></td></td></td></tr></td></td></td></td></td></td></td></td></tr></td></td></td></td></td></td></td></td></tr></th></th></th></th></tr></table></td></td></td></tr></td></td></td></tr></td></td></td></tr></th></th></th></tr></table></td></td></td></td></tr></td></td></td></td></tr></td></td></td></td></tr></td></td></td></td></tr></td></td></td></td></tr></td></td></td></td></tr></td></td></td></td></tr></th></th></th></th></tr></table></td></td></td></tr></td></td></td></tr></td></td></td></tr></table>

      </div>

      <div id="footer">
        <a href="http://www.apache.org">
          <img id="asf-logo" alt="Apache Software Foundation" src="/images/feather-small.gif" height="100">
        </a>
        <div class="copyright">
          <p>
          Copyright &copy; 2011-2016 The Apache Software Foundation, Licensed under
          the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>.
          Apache Accumulo, Accumulo, Apache, the Apache feather logo, and the Apache Accumulo
          project logo are trademarks of the <a href="http://www.apache.org">Apache Software Foundation</a>.<br />
          Site created with <a href="http://getbootstrap.com/">Bootstrap</a> including icons from <a href="http://glyphicons.com/">GLYPHICONS</a> and <a href="http://fontawesome.io/">Font Awesome</a>.
          </p>
        </div>
      </div>
    </div>

  </div>
</div>

<script type="text/javascript">

$(function() {
  return $("h2, h3, h4, h5, h6").each(function(i, el) {
    var $el, icon, id;
    $el = $(el);
    id = $el.attr('id');
    icon = '<i class="fa fa-link"></i>';
    if (id) {
      return $el.append($("<a />").addClass("header-link").attr("href", "#" + id).html(icon));
    }
  });
});
</script>
</body>
</html>
